pico-8 cartridge // http://www.pico-8.com
version 35
__lua__

printh('debug started','debug',true)
function debug(s)
 printh(tostr(s),'debug',false)
end

function sortony(_t)
 for _i=1,#_t do
  local _j = _i
  while _j > 1 and _t[_j-1].y > _t[_j].y do
   _t[_j],_t[_j-1]=_t[_j-1],_t[_j]
   _j=_j-1
  end
 end
end


avatar={
 s=32,
 x=64,y=64,
}

ai={
 s=0,
 x=58,y=58,
 state='idle',
 state_t=2,
 excite=0.1,
}

actors={avatar,ai,}

arslen=128*128-1
lvlw=127
lvlh=128

level={}

ts_init=0

camx,camy=0,0

for _i=0,arslen do
 level[_i]=0
end

level[64*128+64]=1

pal(0,128,1)


function _init()
 ts_init=t()
end

function _update()
 local _elapsed=t()-ts_init

 local _nextx,_nexty=avatar.x,avatar.y
 if btnp(0) then
  _nextx-=1
 elseif btnp(1) then
  _nextx+=1
 end

 if btnp(2) then
  _nexty-=1
 elseif btnp(3) then
  _nexty+=1
 end

 local _i=_nexty*lvlh+_nextx
 if _nextx >= 0 and _nextx <= lvlw and _nexty >= 0 and _nexty < lvlh and level[_i] == 0 then
  avatar.x,avatar.y=_nextx,_nexty
 end

 -- update ai
 for _a in all(actors) do
  if _a.s < 32 then
   if _a.state == 'idle' then
    -- pass

   elseif _a.state == 'enjoying' then
    _a.excite+=0.01

   elseif _a.state == 'lookingaround' then
    -- pass

   elseif _a.state == 'goingto' then
    local _dx=_a.x-_a.targetx
    local _dy=_a.y-_a.targety
    if _dx > 1 then
     _a.x-=1
    elseif _dx < -1 then
     _a.x+=1
    elseif _dy > 1 then
     _a.y-=1
    elseif _dy < -1 then
     _a.y+=1
    else
     _a.state='arriving'
    end
    
   end

   if _a.state_t <= _elapsed then
    if _a.state == 'idle' then
     _a.state='lookingaround'
     _a.state_t=_elapsed+2

    elseif _a.state == 'lookingaround' then
     _a.targetx=64
     _a.targety=64
     _a.state='goingto'

    elseif _a.state == 'goingto' then
     -- pass

    elseif _a.state == 'arriving' then
     _a.state_t=_elapsed+10
     _a.state='enjoying'
    end
   end

  end

 end

 camx=mid(0,avatar.x*8-60,128*8)
 camy=mid(0,avatar.y*8-60,128*8)

 camera(camx,camy)
end

function _draw()
 cls(0)

 for _i=0,arslen do
  local _x,_y=_i&127,_i\128
  _x*=8
  _y*=8
  local _col=5
  if level[_i] == 0 then
   _col=0
  end

  rectfill(_x,_y,_x+7,_y+7,_col)
 end

 sortony(actors)

 for _i=1,#actors do
  local _a=actors[_i]
  spr(_a.s,_a.x*8,_a.y*8)
 end
end

__gfx__
00000000000000000090009000888880000000000000000000bbbbb000c000c00cc0cc0000000000000000000000000000000000000000000000000000000000
0c00000c0b00000b08800088087787780800c008000909000b77b77b00090900c77c77c000000000000000000000000000000000000000000000000000000000
0ccccccc09999999088888880871817800ccccc0000b0b000b71b17b00999990c77c77c000000000000000000000000000000000000000000000000000000000
0c77c77c0977977908778778008888800c77c77c0bbbbbbb00bbbbb0097797790ccccc0000000000000000000000000000000000000000000000000000000000
0c71c17c0971917908718178008000800c71c17c0b77b77b000bbb00097191790000000000000000000000000000000000000000000000000000000000000000
0ccccccc0099999000888880008000800ccccccc0b71b17b000bbb00009999900000000000000000000000000000000000000000000000000000000000000000
00ccccc00b09990b0000800000c000c0000c0c0000bbbbb0008bbb80009909900000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000808000900b0090000b0000c00000c0000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000c80000009b000000890000008c000000c8000000b9000000b80000009c0000000000000000000000000000000000000000000000000000000000000000000
0008c000000b900000098000000c80000008c0000009b0000008b000000c90000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000eee00000eee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000eee00000eee0000eeeee000eeeee0000eee00000eee0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00eeeee000eeeee00e7e77ee0e1e17ee00eeeee000eeeee000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e7e77ee0e1e17ee0e1e17ee0e7e77ee0e7777ee0e7171ee000eee00000eee000000000000000000000000000000000000000000000000000000000000000000
0e1e17ee0e7e77ee0eeeeeee0eeeeeee0e7171ee0e7777ee00eeeee000eeeee00000000000000000000000000000000000000000000000000000000000000000
0eeeeeee0eeeeeee0e888eee0e888eee0eeeeeee0eeeeeee0e7e77ee0e1e17ee0000000000000000000000000000000000000000000000000000000000000000
0eeeeeee0eeeeeee0e888ee00e888ee00ee8eeee0ee8eeee081e178e087e778e0000000000000000000000000000000000000000000000000000000000000000
00eeeee000eeeee000eeee0000eeee0000eeeee000eeeee00eeeeeee0eeeeeee0000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0008e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000e8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0088088000080800088008800dd00dd000dddddd0dddddd0000099000000aa0000eeee0000eeee00077777700777777000000000007700007700000000000000
08e88888008e88808e880888dcdd0dddddddd000000ddddd00099940000aaa400eeeeee00eeeeee0777777777777777700000000070070070070000000000000
088888880088888088828888ddd2dddd00ddddd00ddddd0000099440000aa4400e22ee200e22ee20777777777777777700000000000000000000000000000000
088888880088888088880882dddd0dd20dddd000000dddd000094400000a4400002ee220002ee220777777777777777700000000000000000000000000000000
0088888200088820088288200dd2dd20000ddd0000ddd00000044000000440000002220000022200777777777777777700000000700000000007000000000000
00088820000082000082820000d2d20000dd0000000ddd000099000000aa0000000ee000000ee000077777700777777000000000000000000000000000000000
000082000000000000080000000d00000000d000000d00000099400000aa4000000ee200000ee200000077000000770000000000000000000000000000000000
00000000000000000000000000000000000d00000000d00000044000000440000000220000002200000070000000700000000000000000000000000000000000
